name: CI

on:
  push:
    branches: [ main, master, easyquake_seisbench ]
  pull_request:
    branches: [ main, master, easyquake_seisbench ]
  workflow_dispatch:

jobs:
  test-cpu:
    name: Test CPU on ${{ matrix.os }} (Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-14]
        python-version: ['3.10', '3.11']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install CPU-specific PyTorch
        run: pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

      - name: Install easyQuake with ML dependencies
        run: pip install .[ml]

      - name: Install test dependencies
        run: pip install pytest

      - name: Run tests
        run: pytest

  test-cpu-rockylinux:
    name: Test CPU on Rocky Linux 9 (Python 3.10)
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9

    steps:
      - name: Install system dependencies
        run: |
          dnf install -y python3.10 python3.10-pip git-core
          ln -s /usr/bin/python3.10 /usr/bin/python
          ln -s /usr/bin/pip3.10 /usr/bin/pip

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upgrade pip
        run: pip install --upgrade pip

      - name: Install CPU-specific PyTorch
        run: pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

      - name: Install easyQuake with ML dependencies
        run: pip install .[ml]

      - name: Install test dependencies
        run: pip install pytest

      - name: Run tests
        run: pytest

  test-gpu:
    name: Test GPU on Ubuntu (Python 3.10)
    runs-on: ubuntu-22.04-gpu

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install GPU-enabled PyTorch
        run: pip install torch torchvision torchaudio

      - name: Install easyQuake with ML dependencies
        run: pip install .[ml]

      - name: Install test dependencies
        run: pip install pytest

      - name: Verify GPU is available
        run: |
          python -c "import torch; print('PyTorch version:', torch.__version__); print('CUDA available:', torch.cuda.is_available())"
          python -c "import tensorflow as tf; print('TensorFlow version:', tf.__version__); print('Num GPUs Available: ', len(tf.config.list_physical_devices('GPU')))"

      - name: Run tests
        run: pytest
